<!DOCTYPE html>
<html>
<head>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        .coordinates {
            position: fixed;
            top: 17px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 5px;
        }

        .map-container {
            position: relative;
            width: 100vw;
            height: 90vh;
            margin: 2vh auto;
            border: 2px solid #333;
            overflow: hidden;
            cursor: grab;
        }

        .map-container:active {
            cursor: grabbing;
        }

        .map-grid {
            position: absolute;
            display: grid;
            grid-template-columns: repeat(var(--columns), 512px);
            grid-template-rows: repeat(var(--rows), 512px);
            transform-origin: 0 0;
            transition: transform 0.1s ease-out;
            background-color: #ccc;
        }

        .map-tile {
            width: 512px;
            height: 512px;
            background-color: #f0f0f0;
            position: relative;
            overflow: hidden;
            object-fit: cover;
            display: block;
        }
    </style>
</head>
<body>
    <div class="coordinates">
        Pozícia: <span id="position">x: 0, z: 0</span><br>
        <div id="testData" class="test-data"></div>
    </div>
    <div class="map-container" id="mapContainer">
        <div class="map-grid" id="mapGrid"></div>
    </div>

    <script>
        let isDragging = false;
        let startX, startY;
        let offsetX = 0, offsetY = 0;
        let sever = 1;
        let zapad = 1;
        let juh = 1;
        let vychod = 1;
        let zoom = 1;

        function updateGridProperties() {
            const grid = document.getElementById('mapGrid');
            const columns = zapad + vychod;
            const rows = sever + juh;
            grid.style.setProperty('--columns', columns);
            grid.style.setProperty('--rows', rows);
        }

        function createMapTiles() {
            const baseUrl = 'https://images.weserv.nl/?url=http://mox.chita.cz:8080/basic/0/0/0/tiles/basic/0/';
            const grid = document.getElementById('mapGrid');
            grid.innerHTML = ''; // Clear existing tiles
            
            for (let z = -sever; z < juh; z++) {
                for (let x = -zapad; x < vychod; x++) {
                    const img = document.createElement('img');
                    img.src = `${baseUrl}${250 + x}_${250 + z}.webp`;
                    img.alt = `Map tile ${x}-${z}`;
                    img.className = 'map-tile';
                    img.draggable = false;
                    grid.appendChild(img);
                }
            }
            updateGridProperties();
        }

        function startDrag(e) {
            isDragging = true;
            startX = e.clientX - offsetX;
            startY = e.clientY - offsetY;
            document.getElementById('mapContainer').style.cursor = 'grabbing';
        }

        function dragMove(e) {
            if (!isDragging) return;

            const dx = e.clientX - startX;
            const dy = e.clientY - startY;

            offsetX = dx;
            offsetY = dy;

            const grid = document.getElementById('mapGrid');
            grid.style.transform = `translate(${dx}px, ${dy}px) scale(${zoom})`;
        }

        function stopDrag() {
            isDragging = false;
            document.getElementById('mapContainer').style.cursor = 'grab';
        }

        function getMouseMapPosition(e) {
            const mapContainer = document.getElementById('mapContainer');
            const rect = mapContainer.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            const mapX = Math.floor((mouseX - offsetX)/ zoom - 512 * zapad);
            const mapZ = Math.floor((mouseY - offsetY)/ zoom - 512 * sever);
            
            const positionDisplay = document.getElementById('position');
            positionDisplay.textContent = `x: ${mapX}, z: ${mapZ}`;
            
            return { mapX, mapZ };
        }

        function zoomMap(e) {
			e.preventDefault();

			const oldZoom = zoom;
			if (e.deltaY < 0) {
				zoom *= 1.1;
			} else {
				zoom /= 1.1;
			}
			zoom = Math.min(Math.max(zoom, 0.5), 5);

			// Vypočítame pozíciu myši relatívne k mapContainer
			const mapContainer = document.getElementById('mapContainer');
			const rect = mapContainer.getBoundingClientRect();
			const mouseX = e.clientX - rect.left;
			const mouseY = e.clientY - rect.top;

			// Vypočítame pozíciu myši relatívne ku gridu pred zoomom
			const mouseXBeforeZoom = (mouseX - offsetX) / oldZoom;
			const mouseYBeforeZoom = (mouseY - offsetY) / oldZoom;

			// Vypočítame novú pozíciu myši po zoome
			const mouseXAfterZoom = mouseXBeforeZoom * zoom;
			const mouseYAfterZoom = mouseYBeforeZoom * zoom;

			// Upravíme offsety tak, aby bod pod myšou zostal na rovnakom mieste
			offsetX = mouseX - mouseXAfterZoom;
			offsetY = mouseY - mouseYAfterZoom;

			const grid = document.getElementById('mapGrid');
			grid.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${zoom})`;
		}

        window.onload = function () {
            createMapTiles();

            const mapContainer = document.getElementById('mapContainer');
            mapContainer.addEventListener('mousedown', startDrag);
            mapContainer.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    dragMove(e);
                }
                getMouseMapPosition(e);
            });
            mapContainer.addEventListener('mouseup', stopDrag);
            mapContainer.addEventListener('mouseleave', stopDrag);
            mapContainer.addEventListener('wheel', zoomMap);
        }
    </script>
</body>
</html>
